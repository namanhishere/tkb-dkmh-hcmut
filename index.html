<!doctype html>
<html lang="en">

<head>
    <title>Nhập TKB & Lịch thi ĐKMH</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://apis.google.com/js/api.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/ics-js@0.10.0/ics.min.js"></script>
</head>

<body>
    <div class="container">
        <div style="margin: 5%;"></div>
        <div class="text-center">
            <h1 class="card-title">Ứng dụng nhập thời khóa biểu & lịch thi</h1>
            <p>Bạn đang truy cập vào phiên bản <strong>internal</strong> của dự án. Phiên bản này chỉ hoạt động trên gmail <strong>@hcmut.edu.vn</strong></p>
        </div>
        <div style="margin: 3%;"></div>
        <div class="card card-body">

                <h5 class="card-title">Hướng dẫn lấy dữ liệu</h5>
                <p>Ctrl+A (Chọn tất cả) và Ctrl+C (Sao chép) toàn bộ màn hình hoặc ít nhất phần có thông tin bảng lịch học, lịch thi vào giao diện này.</p>
                <h5>Hỗ trợ chính thức:</h5>
                <ul>
                    <li>Thời khóa biểu và lịch thi từ trang <a href="https://mybk.hcmut.edu.vn/app" target="_blank">Thông tin sinh viên</a></li>
                    <li>Danh sách môn đã đăng kí (giao diện sau khi chọn đợt) của trang: <a href="https://mybk.hcmut.edu.vn/dkmh" target="_blank">Đăng kí môn học</a></li>
                </ul>
        </div>
        <div style="margin: 3%;"></div>
        <div>
            <h4 class="card-title">Nhập dữ liệu tại đây</h4>
            <textarea class="form-control" id="text-box" placeholder="Điền dữ liệu của bạn vào đây" rows="10"></textarea>
            <div style="margin: 1%;"></div>
            <div class="btn-primary btn" id="verifybtn">Xử lý dữ liệu</div>
        </div>
        <div style="margin: 3%;"></div>

        <div class="text-center" id="export-section" style="display: none;">
            <div class="btn-success btn" id="download-ics"> Tải về file ICS</div>
            <div class="btn-danger btn" id="import-google-calendar"> Nhập vào Google Calendar</div>
            <div style="margin-top: 5px;">
                <small>File ICS dùng để nhập vào Apple Calendar, Outlook và các ứng dụng lịch khác.</small>
            </div>
        </div>

        <hr style="margin-top: 2rem; margin-bottom: 2rem;">

        <div>
            <h4 class="card-title">Kết quả</h4>
            <div id="result-container">
                <p class="text-muted">Chưa có dữ liệu. Vui lòng nhập và bấm "Xử lý dữ liệu".</p>
            </div>
        </div>

    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

</body>
<script>
    // Biến toàn cục để lưu trữ dữ liệu đã xử lý
    let finalData = null;

    
//         document.getElementById("text-box").value =`
// ﻿
//   ĐĂNG KÝ MÔN HỌC
// BẢNG ĐĂNG KÝ MÔN HỌC
//  (DT251_D2) Đăng ký bổ sung - hiểu chỉnh môn học Dự thính ngoài giờ HK1/2025-2026 - Kết quả đợt 1
// 1
// CO3103 - Đồ án tổng hợp - cnpm
// 1.0
// Nhóm lớp	DK/ Sĩ số	Ngôn ngữ	Nhóm LT	Giảng viên	Nhóm BT	Giảng viên BT/TN	Sĩ số LT	#
// CC01	76/-5	V	CC01	"Chưa/Đang phân công"			-5	
// Thứ	Tiết	Phòng	CS	BT/TN	Tuần học
// Chưa biết	--	------	1		12345678-0123456--------------
// 2
// CO3001 - Công nghệ phần mềm
// 3.0
// Nhóm lớp	DK/ Sĩ số	Ngôn ngữ	Nhóm LT	Giảng viên	Nhóm BT	Giảng viên BT/TN	Sĩ số LT	#
// CC03	80/-5	V	CC03				-5	
// Thứ	Tiết	Phòng	CS	BT/TN	Tuần học
// Thứ 3	- - - 4 5 - - - - - - - - - - -	C6-402	1		12345678-0123456--------------
// 3
// IM1025 - Quản lý dự án cho kỹ sư
// 3.0
// Nhóm lớp	DK/ Sĩ số	Ngôn ngữ	Nhóm LT	Giảng viên	Nhóm BT	Giảng viên BT/TN	Sĩ số LT	#
// CC01	81/-5	V	CC01	Nguyễn Thị Đức Nguyên			-5	
// Thứ	Tiết	Phòng	CS	BT/TN	Tuần học
// Thứ 6	- 2 3 - - - - - - - - - - - - -	B1-306	1		12345678-0123456--------------
// 4
// CO3109 - T/tập ĐAMH đa ngành-cnpm
// 1.0
// Nhóm lớp	DK/ Sĩ số	Ngôn ngữ	Nhóm LT	Giảng viên	Nhóm BT	Giảng viên BT/TN	Sĩ số LT	#
// CC01	20/-5	V	CC01	"Chưa/Đang phân công"			-5	
// Thứ	Tiết	Phòng	CS	BT/TN	Tuần học
// Chưa biết	--	------	1		12345678-0123456--------------
// 5
// CO3005 - Ng/lý ngôn ngữ lập trình
// 4.0
// Nhóm lớp	DK/ Sĩ số	Ngôn ngữ	Nhóm LT	Giảng viên	Nhóm BT	Giảng viên BT/TN	Sĩ số LT	#
// CC01	55/-5	V	CC01	Nguyễn Hứa Phùng			-5	
// Thứ	Tiết	Phòng	CS	BT/TN	Tuần học
// Thứ 2	- - - 4 5 6 - - - - - - - - - -	A4-510	1		12345678-012345---------------
// 6
// CO2001 - Kỹnăng chnghiệp cho kỹsư
// 3.0
// Nhóm lớp	DK/ Sĩ số	Ngôn ngữ	Nhóm LT	Giảng viên	Nhóm BT	Giảng viên BT/TN	Sĩ số LT	#
// CC01	60/-5	V	CC01	Nguyễn Cao Trí			-5	
// Thứ	Tiết	Phòng	CS	BT/TN	Tuần học
// Thứ 3	- - - - - - - 8 9 - - - - - - -	B6-305	1		12345678-0123456--------------
// 7
// SP1035 - Chủ nghĩa xã hội khoahọc
// 2.0
// Nhóm lớp	DK/ Sĩ số	Ngôn ngữ	Nhóm LT	Giảng viên	Nhóm BT	Giảng viên BT/TN	Sĩ số LT	#
// CC09	79/-5	V	CC09				-5	
// Thứ	Tiết	Phòng	CS	BT/TN	Tuần học
// Thứ 3	- - - - - - - - - - 11 12 - - - -	B1-311	1		12345678-0123-----------------

// Tổng số tín chỉ đăng ký: 17.0 (Dự thính: 0)
// Tổng số môn đăng ký: 7

// TRANG CHÍNH
 
// ĐĂNG KÝ/ HIỆU CHỈNH
// Copyright © 2014-2016 Phòng đào tạo, Đại học Bách Khoa TP.HCM
// ﻿
//         `

    // Ánh xạ tiết học sang giờ cụ thể (bạn có thể tùy chỉnh)
    const TIET_HOC_TIMES = {
        1: {start: "06:00", end: "06:50"},
        2: {start: "07:00", end: "07:50"},
        3: {start: "08:00", end: "08:50"},
        4: {start: "09:00", end: "09:50"},
        5: {start: "10:00", end: "10:50"},
        6: {start: "11:00", end: "11:50"},
        7: {start: "12:00", end: "12:50"},
        8: {start: "13:00", end: "13:50"},
        9: {start: "14:00", end: "14:50"},
        10: {start: "15:00", end: "15:50"},
        11: {start: "16:00", end: "16:50"},
        12: {start: "17:00", end: "17:50"},
        13: {start: "18:00", end: "18:50"},
        14: {start: "19:00", end: "19:50"},
        15: {start: "20:00", end: "20:50"},
        16: {start: "21:00", end: "21:50"}

    };

    // ===== BẮT ĐẦU PHẦN PRASE THỜI KHÓA BIỂU THÔNG TIN SINH VIÊN  =====
    function praseTietThongTinSinhVien(str) {
        str = str.replace(/\s+/g, "");
        if (str === '--' || str === '') return [0];
        if (str.includes("-")) {
            const [start, end] = str.split("-").map(Number);
            return Array.from({ length: end - start + 1 }, (_, i) => start + i);
        }
        return [Number(str)];
    }
    function praseThuThongTinSinhVien(str) {
        let intver = parseInt(str);
        if (isNaN(intver)) return 0
        if (intver === 8) return 0 // chủ nhật là 0
        return intver - 1; // thứ 2 là 1 (JS: 1=Mon), thứ 3 là 2, ..., CN là 0 (JS: 0=Sun)
    }
    function praseTuanHocThongTinSinhVien(str) {
        let arr = str.split("|");
        let result = [];
        for (let item of arr) {
            if (item === "--") { continue; }
            if(item.includes('-')) {
                const [start, end] = item.split('-').map(Number);
                for(let i = start; i <= end; i++) {
                    result.push(i);
                }
            } else {
                result.push(parseInt(item));
            }
        }
        return result;
    }
    function praseThongTinSinhVien(text) {
        const regg = /([0-9]{4})([1-3])\t([A-Z]{2})([0-9]{4})\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t((?:\d{1,2}(?:-\d{1,2})?|--)(?:\|(?:\d{1,2}(?:-\d{1,2})?|--))*)/g;
        let matches = [...text.matchAll(regg)];
        if (matches.length === 0) return 0;
        let info = {
            type: "lichhoc-thongtinsinhvien",
            maHocKi: matches[0][1] + matches[0][2],
            namHoc: parseInt(matches[0][1]) + (matches[0][2] == 1 ? 0 : 1),
            monHoc: []
        }
        for (let match of matches) {
            info.monHoc.push({
                maMon: match[3] + match[4],
                tenMon: match[5],
                tinChi: match[6],
                hocPhi: match[7],
                nhom: match[8],
                thu: praseThuThongTinSinhVien(match[9]),
                tiet: praseTietThongTinSinhVien(match[10]),
                phong: match[12],
                coSo: match[13],
                tuan: praseTuanHocThongTinSinhVien(match[14])
            });
        }
        return info;
    }
    // ===== KẾT THÚC PHẦN PRASE THỜI KHÓA BIỂU THÔNG TIN SINH VIÊN =====

    // ===== BẮT ĐẦU PHẦN PRASE LỊCH THI THÔNG TIN SINH VIÊN =====
    function praseLichThiThongTinSinhVien(text) {
        const regg = /^([0-9]{4})([1-3])\t([A-Z]{2})([0-9]{4}) - ([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^{\t|\n}]+)$/gm;
        let matches = [...text.matchAll(regg)];
        if (matches.length === 0) return 0;
        let info = {
            type: "lichthi-thongtinsinhvien",
            maHocKi: matches[0][1] + matches[0][2],
            namHoc: parseInt(matches[0][1]),
            monHoc: []
        }
        for (let match of matches) {
            info.monHoc.push({
                maMon: match[3] + match[4],
                tenMon: match[5],
                cathi: match[6],
                ngaythi: match[7],
                loaithi: match[8],
                coso: match[9],
                maphong: match[10],
                thu: praseThuThongTinSinhVien(match[11]),
                giobatdau: match[12],
                tongsophut: match[13],
            });
        }
        return info;
    }
    // ===== KẾT THÚC PHẦN PRASE LỊCH THI THÔNG TIN SINH VIÊN =====


    // ===== BẮT ĐẦU PHẦN PRASE THỜI KHÓA BIỂU ĐĂNG KÍ MÔN HỌC =====

    function getInfoKiHocDangKiMonHoc(str) {
        const regex = /([A-Z]+)([0-9]{3})_([A-Z]+)?([0-9]+)?/;
        const match = str.match(regex);

        if (!match) return null;

        return {
            fullMatch: match[0],
            maPhanLoaiHocKI: match[1] || null,
            maHocKi: match[2] || null,
            phanLoaiDot: match[3] || null,
            tenDot: match[4] || null
        };
    }

    function praseThuDangKiMonHoc(str) {
        // Chủ nhật -> 6
        if (/chủ?\s*nhật/i.test(str)) return 6;

        const m = str.match(/\d+/);
        if (!m) return 6; // Mặc định là Chủ Nhật nếu không tìm thấy số 
        return parseInt(m[0], 10) - 2;
    }

    function praseDangKiMonHoc(str) {

        let lines = str.split('\n').map(line => line.trim());

        let regsNhanDienMon = /[0-9]([A-Z]{2}[0-9]{4}) - ([\s\S]*?)([0-9]\.[0-9])/;


        let info = {
            type: "lichhoc-dangkimonhoc",
            maHocKi: "252_D1",
            namHoc: 2025,
            monHoc: []
        };


        let infoDot = getInfoKiHocDangKiMonHoc(str);
        console.log(infoDot);


        if (infoDot) {
            info.maHocKi = infoDot.maHocKi;
            info.namHoc = 2000 + parseInt((infoDot.maHocKi - infoDot.maHocKi%10)/10) + (infoDot.maHocKi == 1 ? 1 : 0); // Năm học bắt đầu
            info.tenDot = infoDot.tenDot;
            info.phanLoaiDot = infoDot.phanLoaiDot;
            info.maPhanLoaiHocKI = infoDot.maPhanLoaiHocKI;
        }

        console.log(infoDot);


        for(let index = 0; index < lines.length; index++) {
            let matching = lines[index].match(regsNhanDienMon);
            if(!matching) continue;


            console.log(matching);


            let maMonHoc = matching[1];
            let tenMonHoc = matching[2].trim();
            let tinChi = parseFloat(matching[3]);
            let nhomLop = lines[index+2].split("\t")[0].trim()
            let countSoTiet = 1
            while(lines[index+3+countSoTiet ].match(regsNhanDienMon) == null ){
                if(lines[index+4+countSoTiet].startsWith("Tổng số tín chỉ đăng ký:")) break;
                let buoiHocRaw = (lines[index+3+countSoTiet]).split("\t");

                if(!buoiHocRaw[0] || buoiHocRaw[0] == "" || buoiHocRaw[0]==undefined || buoiHocRaw[0]==null || buoiHocRaw[0].trim() != "Chưa biết"){

                    info.monHoc.push({
                        maMon: maMonHoc,
                        tenMon: tenMonHoc,
                        tinChi,
                        hocPhi: tinChi,
                        nhom: nhomLop,
                        thu: praseThuDangKiMonHoc(buoiHocRaw[0]),
                        tiet: buoiHocRaw[1].split(" ").map((v,i)=> v=="-"? "99999":i+1).filter(v => v!="99999"),
                        phong: buoiHocRaw[2],
                        coSo: buoiHocRaw[3],
                        tuan: buoiHocRaw[5].split("").filter(v=> v!=" ").map((v,i)=> v=="-"? "99999":i+1).filter(v => v!="99999")
                    });
                }

                countSoTiet++;
            }
            
        }

        console.log(info);
        if (info.monHoc.length === 0) return 0;
        return info;




    }

    // ===== KẾT THÚC PHẦN PRASE THỜI KHÓA BIỂU ĐĂNG KÍ MÔN HỌC =====


    // == BẮT ĐẦU PHẦN PARSE DKMH CHO MOBILE ===
        function praseDangKiMonHocMobile(str) {

        // (Giữ lại phần lấy thông tin chung của học kì nếu bạn cần)
        const infoDot = getInfoKiHocDangKiMonHoc(str);
        const info = {
            type: "lichhoc-dangkimonhoc",
            monHoc: [],
            // Gán các giá trị mặc định hoặc từ infoDot
            maHocKi: infoDot ? infoDot.maHocKi : "N/A",
            namHoc: infoDot ? (2000 + parseInt((infoDot.maHocKi - infoDot.maHocKi % 10) / 10) + (infoDot.maHocKi == 1 ? 1 : 0)) : new Date().getFullYear(),
            tenDot: infoDot ? infoDot.tenDot : "N/A",
            phanLoaiDot: infoDot ? infoDot.phanLoaiDot : "N/A",
            maPhanLoaiHocKI: infoDot ? infoDot.maPhanLoaiHocKI : "N/A"
        };
        const courseBlocksRegex = /[0-9]+\s*\n\s*([A-Z]{2}[0-9]{4}[\s\S]*?)(?=\n\s*[0-9]+\s*\n\s*[A-Z]{2}[0-9]{4}|\nTổng số tín chỉ)/gs;
        
        const courseBlocks = str.match(courseBlocksRegex);

        if (!courseBlocks) return 0; // Không tìm thấy khối môn học nào
        for (let block of courseBlocks) {
            const lines = block.trim().split('\n').map(line => line.trim());
            let maMonHoc = lines[1].split(' - ')[0].trim();
            let tenMonHoc = lines[1].split(' - ')[1].trim();
            let tinChi = parseFloat(lines[2].trim());

            for (let i = 6; i < lines.length; i++) {
                const parts = lines[i].split('\t').map(part => part.trim());
                if (parts.length < 6) continue; // Bỏ qua dòng không đủ thông tin
                if (parts[0] === "Chưa biết") continue; // Bỏ qua dòng "Chưa biết"

                info.monHoc.push({
                    maMon: maMonHoc,
                    tenMon: tenMonHoc,
                    tinChi,
                    hocPhi: tinChi,
                    nhom: parts[0],
                    thu: praseThuDangKiMonHoc(parts[1]),
                    tiet: parts[1].split(' ').map((v, idx) => v === '-' ? '99999' : idx + 1).filter(v => v !== '99999'),
                    phong: parts[2],
                    coSo: parts[2],
                    tuan: parts[5].split('').filter(v => v !== ' ').map((v, idx) => v === '-' ? '99999' : idx + 1).filter(v => v !== '99999')
                });
            }

        }
        if (info.monHoc.length === 0) return 0;

        return info;

    }

    function returnFirstNonZero(arr) {
        for (let item of arr) {
            if (item !== 0) return item;
        }
        return null;
    }

    document.getElementById("verifybtn").onclick = function() {
        let textinput = document.getElementById("text-box").value;
        let result = [
            praseThongTinSinhVien(textinput),
            praseDangKiMonHoc(textinput),
            praseLichThiThongTinSinhVien(textinput),
            praseDangKiMonHocMobile(textinput)
        ]
        
        finalData = returnFirstNonZero(result); // Gán vào biến toàn cục

        if (finalData === null) {
            alert("Không tìm thấy dữ liệu hợp lệ. Vui lòng kiểm tra lại dữ liệu bạn đã nhập.");
            document.getElementById("export-section").style.display = 'none';
            document.getElementById("result-container").innerHTML = '<p class="text-muted">Không tìm thấy dữ liệu hợp lệ.</p>';
            return;
        }

        // Hiển thị kết quả và các nút export
        displayResults(finalData);
        document.getElementById("export-section").style.display = 'block';
    }


    function displayResults(data) {
        const container = document.getElementById("result-container");
        container.innerHTML = ""; // Xóa nội dung cũ

        console.log(data);
        if (data.type === "lichhoc-thongtinsinhvien") {
            
            container.innerHTML += `<p><strong>Loại: </strong> Thời khóa biểu thông tin sinh viên của học kì ${data.maHocKi}</p>`;
        } else if (data.type === "lichthi-thongtinsinhvien") {
            container.innerHTML += `<p><strong>Loại: </strong> Lịch thi thông tin sinh viên của học kì ${data.maHocKi}</p>`;
        } else if (data.type === "lichhoc-dangkimonhoc") {
            // console.log("data.phanLoaiDot", data.phanLoaiDot);
            container.innerHTML += `<p><strong>Loại: </strong> Thời khóa biểu đăng kí môn học của học kì ${data.maHocKi} (${data.phanLoaiDot == "D" ? "Đợt " : data.phanLoaiDot}${data.tenDot})</p>`;

            let defaultValue 
            console.log(data.namHoc)
            // tự động tính toán đợt
            if(data.maPhanLoaiHocKI == "HK" && data.phanLoaiDot == "D") { // chỉ phân loại cho hk chính

                if(data.maHocKi %10 == 2){
                    // cài tự động là tuần thứ 2 của năm đó nếu là hk1
                    let resultDay  = getDateOfWeekDay(data.namHoc, 2, 1);
                    defaultValue = formatDateToYMD(resultDay);
                    alert("Nhận diện tự động là học kì 2. Tụ động cài này bắt đầu là " + defaultValue + ". Vui lòng kiểm tra lại ngày bắt đầu học kì bên dưới.");

                }else if(data.maHocKi %10 == 1){
                    // cài tự động là tuần thứ 35 của năm đó nếu là hk2
                    let resultDay  = getDateOfWeekDay(data.namHoc, 35, 1);
                    defaultValue = formatDateToYMD(resultDay);
                    alert("Nhận diện tự động là học kì 1. Tụ động cài này bắt đầu là " + defaultValue + ". Vui lòng kiểm tra lại ngày bắt đầu học kì bên dưới.");
                }

            }

            container.innerHTML +=`
            <strong>Chú ý: </strong>Vui lòng nhập vào ô dưới <strong> ngày thứ 2</strong> của tuần bắt đầu học kì (định dạng tháng/ngày/năm): <br/>
            <div style="margin: 1%;"></div>
                <input type="date" id="start-date-picker" class="form-control"  value="${defaultValue}">
            <div style="margin: 1%;"></div>
            <p>Tham khảo lịch học vụ trường tại: <a href="https://hcmut.edu.vn/dao-tao/lich-hoc-vu" target="_blank">https://hcmut.edu.vn/dao-tao/lich-hoc-vu    </a></p>

            `;
        }

        let table = `<table class="table table-striped table-bordered">`;
        if (data.type.startsWith('lichhoc-')) {
            table += `
                <thead class="thead-dark">
                    <tr>
                        <th>Môn học</th>
                        <th>Nhóm</th>
                        <th>Thứ</th>
                        <th>Tiết</th>
                        <th>Phòng</th>
                        <th>Tuần học</th>
                    </tr>
                </thead>
                <tbody>
            `;
            data.monHoc.forEach(mon => {
                table += `
                    <tr>
                        <td>${mon.tenMon} (${mon.maMon})</td>
                        <td>${mon.nhom}</td>
                        <td>${mon.thu === 0 ? 'Chủ Nhật' : 'Thứ ' + (mon.thu + 1)}</td>
                        <td>${mon.tiet.join(', ')}</td>
                        <td>${mon.phong}</td>
                        <td>${mon.tuan.join(', ')}</td>
                    </tr>
                `;
            });
        } else if (data.type.startsWith('lichthi-')) {
            table += `
                <thead class="thead-dark">
                    <tr>
                        <th>Môn học</th>
                        <th>Loại thi</th>
                        <th>Ngày thi</th>
                        <th>Giờ bắt đầu</th>
                        <th>Phòng</th>
                        <th>Cơ sở</th>
                    </tr>
                </thead>
                <tbody>
            `;
            data.monHoc.forEach(mon => {
                table += `
                    <tr>
                        <td>${mon.tenMon} (${mon.maMon})</td>
                        <td>${mon.loaithi}</td>
                        <td>${mon.ngaythi}</td>
                        <td>${mon.giobatdau}</td>
                        <td>${mon.maphong}</td>
                        <td>${mon.coso}</td>
                    </tr>
                `;
            });
        }
        table += `</tbody></table>`;
        container.innerHTML += table;
    }
    function formatDateToYMD(date) {
        const year = date.getFullYear();
        // getMonth() trả về từ 0-11, nên cần +1
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');

        return `${year}-${month}-${day}`;
    }
    function getDateOfWeekDay(year, weekNumber, dayOfWeek) {
        const firstDayOfYear = new Date(year, 0, 1);
        const days = (weekNumber - 1) * 7;
        const date = new Date(firstDayOfYear.valueOf());
        date.setDate(date.getDate() + days);
        const day = date.getDay();
        const diff = dayOfWeek - day;
        date.setDate(date.getDate() + diff);
        return date;
    }

    function groupConsecutiveWeeks(weeks) {
        if (!weeks || weeks.length === 0) return [];
        weeks.sort((a, b) => a - b);
        const result = [[weeks[0]]];
        for (let i = 1; i < weeks.length; i++) {
            if (weeks[i] === weeks[i - 1] + 1) {
                result[result.length - 1].push(weeks[i]);
            } else {
                result.push([weeks[i]]);
            }
        }
        return result;
    }

    function autoFixMonDay(finalData){
        if (finalData.type === 'lichhoc-dangkimonhoc') {
            const startDateInput = document.getElementById('start-date-picker').value;
            if (!startDateInput) {
                alert("Vui lòng chọn ngày bắt đầu học kì!");
                return;
            }
            let startDate = new Date(startDateInput);
            let year = startDate.getFullYear();
            let month = startDate.getMonth() + 1; // Tháng trong JS từ 0-11
            let day = startDate.getDate();

            // tự động hiệu chỉnh ngày về ngày thứ 2 nếu không phải thứ 2
            let dayOfWeek = startDate.getDay(); // 0=CN, 1=T2, ..., 6=T7
            if (dayOfWeek !== 1) {
                let diffToMonday = (dayOfWeek === 0) ? -6 : (1 - dayOfWeek);
                startDate.setDate(day + diffToMonday);
                alert(`Ngày bạn chọn không phải thứ 2. Hệ thống đã tự động điều chỉnh về ngày thứ 2 gần nhất: ${startDate.toISOString().split('T')[0]}.`);
                document.getElementById('start-date-picker').value = startDate.toISOString().split('T')[0];

            }
        }
    }


    // ===== TẠO FILE .ICS =======================================

    function formatICSDate(date) {
        // YYYYMMDDTHHmmssZ
        return date.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
    }

    function getICSContent(events) {
        let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VTIMEZONE
TZID:Asia/Ho_Chi_Minh
TZURL:http://tzurl.org/zoneinfo-outlook/Asia/Ho_Chi_Minh
X-LIC-LOCATION:Asia/Ho_Chi_Minh
BEGIN:STANDARD
TZOFFSETFROM:+0700
TZOFFSETTO:+0700
TZNAME:+07
DTSTART:19700101T000000
END:STANDARD
END:VTIMEZONE\n`; // keep old header from ics

        events.forEach(ev => {
            icsContent += "BEGIN:VEVENT\n";
            icsContent += `SUMMARY:${ev.title}\n`;
            if (ev.description) icsContent += `DESCRIPTION:${ev.description}\n`;
            if (ev.location)    icsContent += `LOCATION:${ev.location}\n`;
            icsContent += `DTSTART:${formatICSDate(ev.start)}\n`;
            icsContent += `DTEND:${formatICSDate(ev.end)}\n`;
            if (ev.rrule)       icsContent += `RRULE:${ev.rrule}\n`;
            icsContent += "END:VEVENT\n";
        });

        icsContent += "END:VCALENDAR";

        // const blob = new Blob([icsContent], { type: "text/calendar;charset=utf-8" });
        // const link = document.createElement("a");
        // link.href = URL.createObjectURL(blob);
        // link.download = filename;
        // link.click();
        return icsContent;
    }

    document.getElementById('download-ics').onclick = function() {
        if (!finalData) {
            alert("Chưa có dữ liệu để xuất file!");
            return;
        }

        let events = [];
        const timeZone = 'Asia/Ho_Chi_Minh';

        if (finalData.type === 'lichhoc-thongtinsinhvien') {
            finalData.monHoc.forEach(mon => {
                if (mon.tiet.includes(0)) return;

                const startTiet = Math.min(...mon.tiet);
                const endTiet   = Math.max(...mon.tiet);
                const startTime = TIET_HOC_TIMES[startTiet].start;
                const endTime   = TIET_HOC_TIMES[endTiet].end;

                const weekGroups = groupConsecutiveWeeks(mon.tuan);

                weekGroups.forEach(group => {
                    const firstWeek = group[0];
                    const lastWeek  = group[group.length - 1];

                    const startDate = getDateOfWeekDay(finalData.namHoc, firstWeek, mon.thu);
                    const [startHour, startMinute] = startTime.split(':');
                    startDate.setHours(startHour, startMinute, 0, 0);

                    const endDate = new Date(startDate);
                    const [endHour, endMinute] = endTime.split(':');
                    endDate.setHours(endHour, endMinute, 0, 0);

                    const untilDate = getDateOfWeekDay(finalData.namHoc, lastWeek, mon.thu);
                    untilDate.setHours(23, 59, 59, 999);

                    events.push({
                        title: `${mon.maMonHoc} - ${mon.tenMon}`,
                        description: `Mã môn: ${mon.maMon}\nNhóm: ${mon.nhom}`,
                        location: `Phòng ${mon.phong}, ${mon.coSo}`,
                        start: startDate,
                        end: endDate,
                        rrule: `FREQ=WEEKLY;UNTIL=${formatICSDate(untilDate)}`
                    });
                });
            });
        } else if (finalData.type === 'lichthi-thongtinsinhvien') {
            finalData.monHoc.forEach(mon => {
                const [year, month, day] = mon.ngaythi.split('-');
                const [hour, minute] = mon.giobatdau.replace('g', ':').split(':');

                const start = new Date(year, month - 1, day, hour, minute);
                const end   = new Date(start.getTime() + mon.tongsophut * 60000);

                events.push({
                    title: `[Thi ${mon.loaithi}] ${mon.tenMon}`,
                    description: `Mã môn: ${mon.maMon}\nCa thi: ${mon.cathi}`,
                    location: `Phòng ${mon.maphong}, ${mon.coso}`,
                    start, end
                });
            });
        } else if (finalData.type === 'lichhoc-dangkimonhoc') {
            const startDateInput = document.getElementById('start-date-picker').value;
            if (!startDateInput) {
                alert("Vui lòng chọn ngày bắt đầu học kì!");
                return;
            }

            if (finalData.type === "lichhoc-dangkimonhoc") {
                autoFixMonDay(finalData); 
            }

            const [startYear, startMonth, startDay] = startDateInput.split('-').map(Number);
            const semesterStartDate = new Date(startYear, startMonth - 1, startDay);

            // const events = [];

            finalData.monHoc.forEach(mon => {
                if (mon.tiet.includes(0)) return;

                const startTiet = Math.min(...mon.tiet);
                const endTiet   = Math.max(...mon.tiet);
                const startTime = TIET_HOC_TIMES[startTiet].start;
                const endTime   = TIET_HOC_TIMES[endTiet].end;

                const weekGroups = groupConsecutiveWeeks(mon.tuan);
                console.log('Week groups for', mon.maMon, mon.tenMon, ':', weekGroups);

                weekGroups.forEach(group => {
                    const firstWeek = group[0];
                    const lastWeek  = group[group.length - 1];

                    const startDate = new Date(semesterStartDate);
                    startDate.setDate(startDate.getDate() + (firstWeek - 1) * 7 + mon.thu);
                    const [startHour, startMinute] = startTime.split(':');
                    startDate.setHours(startHour, startMinute, 0, 0);

                    const endDate = new Date(startDate);
                    const [endHour, endMinute] = endTime.split(':');
                    endDate.setHours(endHour, endMinute, 0, 0);

                    const untilDate = new Date(semesterStartDate);
                    untilDate.setDate(untilDate.getDate() + (lastWeek - 1) * 7 + mon.thu);
                    untilDate.setHours(23, 59, 59, 999);

                    const ev = {
                        title: `${mon.maMon}-${mon.tenMon}`,
                        description: `Mã môn: ${mon.maMon}\nNhóm: ${mon.nhom}`,
                        location: `Phòng ${mon.phong}, Cơ sở: ${mon.coSo}`,
                        start: startDate,
                        end: endDate
                    };

                    if (group.length > 1) {
                        const untilISO = untilDate.toISOString().split('.')[0].replace(/[-:]/g, '') + 'Z';
                        ev.rrule = `FREQ=WEEKLY;UNTIL=${untilISO}`;
                    }

                    console.log('Adding event:', ev);
                    events.push(ev);
                });
            });

        }
            


        console.log(events);
        let icsContent = getICSContent(events);
        document.getElementById('result-container').innerHTML += "<br/><h5>Nội dung file .ics:</h5><br/>";

        document.getElementById('result-container').innerHTML += icsContent.split("\n").map(line => line.replace(/ /g, '&nbsp;')).join("<br/>");

        console.log(icsContent);

        const blob = new Blob([icsContent], { type: "text/calendar;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);

        if (finalData.type === 'lichhoc-thongtinsinhvien') {
            link.download = `[Lịch học] ${finalData.maHocKi}.ics`;
        } else if (finalData.type === 'lichthi-thongtinsinhvien') {
            link.download = `[Lịch thi] ${finalData.maHocKi}.ics`;
        } else if (finalData.type === 'lichhoc-dangkimonhoc') {
            link.download = `[ĐKMH] ${finalData.maHocKi} - ${finalData.phanLoaiDot}${finalData.tenDot}.ics`;
        }
        link.click();

    };


    // ===== NHẬP VÀO GOOGLE CALENDAR (OAUTH 2.0) ===============


    const CLIENT_ID = '70228146921-k2g4fc96nb4n02aa8232rfiduct2tsff.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyBxy7yvungSMjVF_E8a2SxuAqaKj77npzw'; 
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/calendar';


    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    document.getElementById('import-google-calendar').style.visibility = 'hidden';

    function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
        await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', 
        });
        gisInited = true;
        maybeEnableButtons();
    }

    function maybeEnableButtons() {
        if (gapiInited && gisInited) {
            document.getElementById('import-google-calendar').style.visibility = 'visible';
        }
    }

    document.getElementById('import-google-calendar').onclick = function() {
        if (!finalData) {
            alert("Chưa có dữ liệu để nhập!");
            return;
        }





        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) {
                throw (resp);
            }
            // Đã có token, tiến hành thêm sự kiện
            await addEventsToGoogleCalendar(finalData);
        };

        if (gapi.client.getToken() === null) {
            // Yêu cầu token nếu chưa có
            tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {

            addEventsToGoogleCalendar(finalData);
        }
    }

    async function addEventsToGoogleCalendar(data) {
        const timeZone = 'Asia/Ho_Chi_Minh';
        const batch = gapi.client.newBatch();
        let eventCount = 0;
        let newCalendarId = '';




        //create new calendar 
        try {
            let calendar = {
                'summary': "",
                'timeZone': timeZone
            };

            if (data.type === 'lichhoc-thongtinsinhvien') {
                calendar.summary = `[Lịch học] ${data.maHocKi}`;
            } else if (data.type === 'lichthi-thongtinsinhvien') {
                calendar.summary = `[Lịch thi] ${data.maHocKi}`;
            } else if (data.type === 'lichhoc-dangkimonhoc') {
                calendar.summary = `[ĐKMH] ${data.maHocKi} - ${data.phanLoaiDot}${data.tenDot}`;
            }
            

            const createCalendarRequest = gapi.client.calendar.calendars.insert({
                'resource': calendar
            });
            const createCalendarResponse = await createCalendarRequest;

            newCalendarId = createCalendarResponse.result.id; 
            console.log('Created new calendar with ID:', newCalendarId);

        } catch (err) {
            console.error('Error creating calendar:', err);
            alert("Đã xảy ra lỗi khi tạo lịch mới. Vui lòng xem console để biết chi tiết. Lỗi này thường do bạn chưa cấp đủ quyền (scope) cho ứng dụng.");
            return;
        }

        try {
            if (data.type === 'lichhoc-thongtinsinhvien') {
                data.monHoc.forEach(mon => {
                    if (mon.tiet.includes(0)) return;

                    const startTiet = Math.min(...mon.tiet);
                    const endTiet = Math.max(...mon.tiet);
                    const startTime = TIET_HOC_TIMES[startTiet].start;
                    const endTime = TIET_HOC_TIMES[endTiet].end;

                    const weekGroups = groupConsecutiveWeeks(mon.tuan);
                    console.log('Week groups for', mon.maMon, mon.tenMon, ':', weekGroups);
                    weekGroups.forEach(group => {
                        const firstWeek = group[0];
                        const lastWeek = group[group.length - 1];

                        const startDate = getDateOfWeekDay(data.namHoc, firstWeek, mon.thu);
                        const [startHour, startMinute] = startTime.split(':');
                        startDate.setHours(startHour, startMinute, 0, 0);

                        const endDate = new Date(startDate);
                        const [endHour, endMinute] = endTime.split(':');
                        endDate.setHours(endHour, endMinute, 0, 0);

                        const untilDate = getDateOfWeekDay(data.namHoc, lastWeek, mon.thu);
                        untilDate.setHours(23, 59, 59, 999);

                        const event = {
                            'summary': `${mon.maMon} - ${mon.tenMon}`,
                            'location': `Phòng ${mon.phong}, ${mon.coSo}`,
                            'description': `Mã môn: ${mon.maMon}\nNhóm: ${mon.nhom}`,
                            'start': { 'dateTime': startDate.toISOString(), 'timeZone': timeZone },
                            'end': { 'dateTime': endDate.toISOString(), 'timeZone': timeZone },

                        };
                        if(group.length > 1) {
                            const untilISO = untilDate.toISOString().split('.')[0].replace(/[-:]/g, '') + 'Z';
                            event.recurrence = [`RRULE:FREQ=WEEKLY;UNTIL=${untilISO}`];
                        }

                        console.log('Adding event:', event);
                        console.log(`Tuần: ${firstWeek}-${lastWeek}`, 'Ngày bắt đầu:', startDate, 'Ngày kết thúc lặp:', untilDate);
                        batch.add(gapi.client.calendar.events.insert({ 'calendarId': newCalendarId, 'resource': event }));
                        eventCount++;
                    });
                });
            } else if (data.type === 'lichthi-thongtinsinhvien') {
                data.monHoc.forEach(mon => {
                    const [year, month, day] = mon.ngaythi.split('-');
                    const [hour, minute] = mon.giobatdau.replace('g', ':').split(':');

                    const start = new Date(year, month - 1, day, hour, minute);
                    const end = new Date(start.getTime() + mon.tongsophut * 60000);

                    const event = {
                        'summary': `[Thi ${mon.loaithi}] ${mon.tenMon}`,
                        'location': `Phòng ${mon.maphong}, ${mon.coso}`,
                        'description': `Mã môn: ${mon.maMon}\nCa thi: ${mon.cathi}\nThời gian làm bài: ${mon.tongsophut} phút`,
                        'start': { 'dateTime': start.toISOString(), 'timeZone': timeZone },
                        'end': { 'dateTime': end.toISOString(), 'timeZone': timeZone }
                    };
                    batch.add(gapi.client.calendar.events.insert({ 'calendarId': newCalendarId, 'resource': event }));
                    eventCount++;
                });

            } else if (data.type === 'lichhoc-dangkimonhoc') {
                const startDateInput = document.getElementById('start-date-picker').value;
                if (!startDateInput) {
                    alert("Vui lòng chọn ngày bắt đầu học kì!");
                    return;
                }

                if(finalData.type == "lichhoc-dangkimonhoc"){
                    autoFixMonDay(finalData);
                }

                
                const [startYear, startMonth, startDay] = startDateInput.split('-').map(Number);
                const semesterStartDate = new Date(startYear, startMonth - 1, startDay);

                data.monHoc.forEach(mon => {
                    if (mon.tiet.includes(0)) return;

                    const startTiet = Math.min(...mon.tiet);
                    const endTiet = Math.max(...mon.tiet);
                    const startTime = TIET_HOC_TIMES[startTiet].start;
                    const endTime = TIET_HOC_TIMES[endTiet].end;

                    const weekGroups = groupConsecutiveWeeks(mon.tuan);
                    console.log('Week groups for', mon.maMon, mon.tenMon, ':', weekGroups);
                    weekGroups.forEach(group => {
                        const firstWeek = group[0];
                        const lastWeek = group[group.length - 1];

                        const startDate = new Date(semesterStartDate);
                        startDate.setDate(startDate.getDate() + (firstWeek - 1) * 7 + mon.thu);
                        const [startHour, startMinute] = startTime.split(':');
                        startDate.setHours(startHour, startMinute, 0, 0);

                        const endDate = new Date(startDate);
                        const [endHour, endMinute] = endTime.split(':');
                        endDate.setHours(endHour, endMinute, 0, 0);

                        const untilDate = new Date(semesterStartDate);
                        untilDate.setDate(untilDate.getDate() + (lastWeek - 1) * 7 + mon.thu);
                        untilDate.setHours(23, 59, 59, 999);

                        const event = {
                            'summary': `${mon.maMon} - ${mon.tenMon}`,
                            'location': `Phòng ${mon.phong}, ${mon.coSo}`,
                            'description': `Mã môn: ${mon.maMon}\nNhóm: ${mon.nhom}`,
                            'start': { 'dateTime': startDate.toISOString(), 'timeZone': timeZone },
                            'end': { 'dateTime': endDate.toISOString(), 'timeZone': timeZone },
                        };
                        if(group.length > 1) {
                            const untilISO = untilDate.toISOString().split('.')[0].replace(/[-:]/g, '') + 'Z';
                            event.recurrence = [`RRULE:FREQ=WEEKLY;UNTIL=${untilISO}`];
                        }
                        console.log('Adding event:', event);
                        console.log(`Tuần: ${firstWeek}-${lastWeek}`, 'Ngày bắt đầu:', startDate, 'Ngày kết thúc lặp:', untilDate);
                        batch.add(gapi.client.calendar.events.insert({ 'calendarId': newCalendarId, 'resource': event }));
                        eventCount++;
                    });
                });
            }
                

            if (eventCount > 0) {
                 alert(`Chuẩn bị tiến hành thêm ${eventCount} sự kiện vào Google Calendar. Vui lòng không đóng cửa sổ này và chờ đến khi có thông báo hoàn thành. Bấm OK để bắt đầu.`);
                 await batch;
                 alert(`Đã thêm thành công ${eventCount} sự kiện! Vui lòng kiểm tra Google Calendar của bạn.`);
            } else {
                 alert("Không có sự kiện nào hợp lệ để thêm.");
            }

        } catch (err) {
            console.error('Execute error', err);
            alert("Đã xảy ra lỗi khi thêm sự kiện. Vui lòng xem console để biết chi tiết.");
        }
    }
</script>

</html>